<html>
<head>
  <title>draw-something</title>
  <style>
    .central {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        cursor: none;
    }
  </style>
  <script src="./draw_something_artblocks.js" type="text/javascript"></script>
  <script type="text/javascript">

    // Handle compatibility

    window.requestAnimFrame = (function(callback) {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
    })();

    // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest

    async function digestMessage(message) {
      const msgUint8 = new TextEncoder().encode(message); // encode as (utf-8) Uint8Array
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8); // hash the message
      const hashArray = Array.from(new Uint8Array(hashBuffer)); // convert buffer to byte array
      const hashHex = hashArray
            .map((b) => b.toString(16).padStart(2, "0"))
            .join(""); // convert bytes to hex string
      return hashHex;
    }

    // Make the drawing and start animating

    window.onload = async function () {
      var DrawingArtblocks = require('drawing_artblocks');
      var canvas = document.getElementById ('canvas');
      console.log(canvas);
      // 4 endless loops!
      //var seed = 4;
      if (typeof tokenData === 'undefined') {
        tokenData = {
          hash: await digestMessage(Date.now())
        };
      }
      console.log(tokenData.hash);
      window.draw_something = new DrawingArtblocks (canvas, 12, tokenData.hash);
      animate();
    };
    
    // Update and draw the drawing, until it's finished

    function animate() {
      var still_drawing = window.draw_something.update();

      draw_something.drawInProgress ();

      if (still_drawing) {
        requestAnimFrame (function () {
          animate ();
        });
      } else {
        draw_something.drawComplete();
      }
    }

    // Todo: toggle animation, start new drawing, toggle skeleton
    
  </script>
</head>
<body>
  <div class="central">
    <canvas id="canvas" width="1920" height="1080"></canvas>
  </div>
</body>
</html>
